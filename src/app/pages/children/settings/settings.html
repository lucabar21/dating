<!-- üî• LOADING STATE -->
<app-spinner *ngIf="loading" class="spinner"></app-spinner>

<!-- üî• ERROR STATE -->
<div class="error-container" *ngIf="error && !loading">
  <div class="error-icon">‚ö†Ô∏è</div>
  <h2 class="error-title">Errore nel caricamento</h2>
  <p class="error-message">{{ error }}</p>
  <button class="retry-btn" (click)="retryLoadProfile()">üîÑ Riprova</button>
</div>

<!-- üî• MAIN CONTENT (SOLO QUANDO CARICATO) -->
<div class="wrapper" *ngIf="!loading && !error">
  <div class="justify-content-center">
    <!-- Tabs Navigation -->
    <div class="tabs-wrapper">
      <ul class="tabs" role="tablist">
        <li
          [class.active]="selectedTab === 'account'"
          (click)="selectedTab = 'account'"
        >
          üë§<span class="tab-text"> Account</span>
        </li>
        <li
          [class.active]="selectedTab === 'matching'"
          (click)="selectedTab = 'matching'"
        >
          üíï<span class="tab-text"> Matching</span>
        </li>
        <li
          [class.active]="selectedTab === 'theme'"
          (click)="selectedTab = 'theme'"
        >
          üé®<span class="tab-text"> Tema</span>
        </li>
        <li
          [class.active]="selectedTab === 'notifications'"
          (click)="selectedTab = 'notifications'"
        >
          üîî<span class="tab-text"> Notifiche</span>
        </li>
        <li
          [class.active]="selectedTab === 'actions'"
          (click)="selectedTab = 'actions'"
        >
          ‚ö†Ô∏è<span class="tab-text"> Azioni</span>
        </li>
      </ul>
    </div>

    <!-- üî• ACCOUNT TAB -->
    <div *ngIf="selectedTab === 'account'" class="ng-div">
      <!-- Account Info Section -->
      <div class="settings-card mb-4">
        <div class="section-header">
          <h3 class="mb-0">üë§ Informazioni Account</h3>
        </div>
        <div class="">
          <!-- üî• PROFILE IMAGE - CON DATI REALI -->
          <div class="profile-image-wrapper" (click)="triggerFileInput()">
            <img
              *ngIf="userProfile.profileImageUrl; else placeholder"
              [src]="userProfile.profileImageUrl"
              alt="Foto profilo"
              class="profile-image"
              (error)="onImageError($event)"
            />

            <ng-template #placeholder>
              <div class="profile-placeholder-text">
                Aggiungi / Modifica<br />Immagine Profilo
              </div>
            </ng-template>

            <div *ngIf="userProfile.profileImageUrl" class="edit-label">
              Modifica
            </div>

            <input
              type="file"
              #fileInput
              (change)="onFileSelected($event)"
              accept="image/*"
              hidden
            />
          </div>

          <!-- üî• NOME - CON DATI REALI -->
          <div class="editable-field" [class.editing]="editingFields.nome">
            <div class="field-info">
              <div class="field-label">Nome</div>
              <div class="field-value" *ngIf="!editingFields.nome">
                {{ userProfile.nome || 'Nome non inserito' }}
              </div>
              <input
                type="text"
                class="field-input"
                [(ngModel)]="userProfile.nome"
                *ngIf="editingFields.nome"
                placeholder="Inserisci il tuo nome"
                #nomeInput
              />
            </div>
            <div class="field-actions">
              <button
                class="edit-btn"
                *ngIf="!editingFields.nome"
                (click)="startEdit('nome')"
                [disabled]="saving"
              >
                Modifica <i class="fas fa-edit"></i>
              </button>
              <button
                class="save-btn"
                *ngIf="editingFields.nome"
                (click)="saveField('nome')"
                [disabled]="saving"
              >
                {{ saving ? 'Salvando...' : 'Salva' }}
              </button>
              <button
                class="cancel-btn"
                *ngIf="editingFields.nome"
                (click)="cancelEdit('nome')"
                [disabled]="saving"
              >
                Annulla
              </button>
            </div>
          </div>

          <!-- üî• EMAIL/USERNAME - SOLO VISUALIZZAZIONE -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Email/Username</div>
              <div class="field-value">{{ userProfile.username }}</div>
            </div>
            <div class="field-actions">
              <span class="info-text">Non modificabile</span>
            </div>
          </div>

          <!-- üî• GENERE - EDITABILE come Nome/Bio -->
          <div class="editable-field" [class.editing]="editingFields.genere">
            <div class="field-info">
              <div class="field-label">Genere</div>
              <div class="field-value" *ngIf="!editingFields.genere">
                {{ userProfile.genere || 'Non specificato' }}
              </div>
              <select
                class="field-input"
                *ngIf="editingFields.genere"
                [(ngModel)]="userProfile.genere"
                #genereInput
              >
                <option value="">Seleziona</option>
                <option value="MASCHIO">MASCHIO</option>
                <option value="FEMMINA">FEMMINA</option>
              </select>
            </div>
            <div class="field-actions">
              <button
                class="edit-btn"
                *ngIf="!editingFields.genere"
                (click)="startEdit('genere')"
                [disabled]="saving"
              >
                Modifica <i class="fas fa-edit"></i>
              </button>
              <button
                class="save-btn"
                *ngIf="editingFields.genere"
                (click)="saveField('genere')"
                [disabled]="saving"
              >
                {{ saving ? 'Salvando...' : 'Salva' }}
              </button>
              <button
                class="cancel-btn"
                *ngIf="editingFields.genere"
                (click)="cancelEdit('genere')"
                [disabled]="saving"
              >
                Annulla
              </button>
            </div>
          </div>

          <!-- üî• BIO - CON DATI REALI -->
          <div class="editable-field" [class.editing]="editingFields.bio">
            <div class="field-info">
              <div class="field-label">Bio</div>
              <div class="field-value" *ngIf="!editingFields.bio">
                {{ userProfile.bio || 'Raccontaci qualcosa di te...' }}
              </div>
              <textarea
                class="field-input"
                rows="3"
                [(ngModel)]="userProfile.bio"
                *ngIf="editingFields.bio"
                placeholder="Raccontaci qualcosa di te..."
                #bioInput
              ></textarea>
            </div>
            <div class="field-actions">
              <button
                class="edit-btn"
                *ngIf="!editingFields.bio"
                (click)="startEdit('bio')"
                [disabled]="saving"
              >
                Modifica <i class="fas fa-edit"></i>
              </button>
              <button
                class="save-btn"
                *ngIf="editingFields.bio"
                (click)="saveField('bio')"
                [disabled]="saving"
              >
                {{ saving ? 'Salvando...' : 'Salva' }}
              </button>
              <button
                class="cancel-btn"
                *ngIf="editingFields.bio"
                (click)="cancelEdit('bio')"
                [disabled]="saving"
              >
                Annulla
              </button>
            </div>
          </div>

          <!-- üî• INTERESSI - CON DATI REALI -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Interessi</div>
              <div class="field-value">I tuoi interessi e passioni</div>
              <div class="interests-display">
                <span
                  class="selected-interest"
                  *ngFor="let interest of getSelectedInterestsDisplay()"
                >
                  {{ interest }}
                </span>
                <span
                  *ngIf="selectedInterests.length === 0"
                  class="no-interests-text"
                >
                  Nessun interesse selezionato
                </span>
              </div>
            </div>
            <div class="field-actions">
              <button
                class="password-btn interests-btn"
                (click)="openInterestsModal()"
                [disabled]="saving"
              >
                <i class="fas fa-tags"></i> Modifica Interessi
              </button>
            </div>
          </div>

          <!-- üî• CITT√Ä - EDITABILE con AUTOCOMPLETAMENTO -->
          <div class="editable-field" [class.editing]="editingFields.citta">
            <div class="field-info">
              <div class="field-label">Citt√†</div>
              <div class="field-value" *ngIf="!editingFields.citta">
                {{ selectedCity?.name || userProfile.citta || 'Citt√† non
                specificata' }}
              </div>

              <!-- INPUT CON AUTOCOMPLETAMENTO quando in editing -->
              <div
                *ngIf="editingFields.citta"
                class="city-autocomplete-container"
              >
                <input
                  type="text"
                  class="field-input"
                  [(ngModel)]="cityQuery"
                  (input)="searchCities(cityQuery)"
                  (focus)="searchCities(cityQuery)"
                  (blur)="hideCitySuggestions()"
                  placeholder="Cerca citt√† italiana..."
                  [disabled]="saving"
                  #cittaInput
                />

                <!-- Dropdown suggerimenti -->
                <div class="city-suggestions" *ngIf="showCitySuggestions">
                  <div
                    *ngFor="let city of citySuggestions"
                    class="city-suggestion-item"
                    (click)="onCitySelect(city)"
                  >
                    <strong>{{ city.name }}</strong>
                    <small>{{ city.fullName }}</small>
                  </div>
                  <div
                    *ngIf="citySuggestions.length === 0"
                    class="no-suggestions"
                  >
                    Nessuna citt√† trovata
                  </div>
                </div>
              </div>
            </div>

            <div class="field-actions">
              <button
                class="edit-btn"
                *ngIf="!editingFields.citta"
                (click)="startEditCity()"
                [disabled]="saving"
              >
                Modifica <i class="fas fa-edit"></i>
              </button>
              <button
                class="save-btn"
                *ngIf="editingFields.citta"
                (click)="saveCityField()"
                [disabled]="saving || !selectedCity"
              >
                {{ saving ? 'Salvando...' : 'Salva' }}
              </button>
              <button
                class="cancel-btn"
                *ngIf="editingFields.citta"
                (click)="cancelEditCity()"
                [disabled]="saving"
              >
                Annulla
              </button>
            </div>
          </div>

          <!-- üî• DATA DI NASCITA EDITABILE -->
          <div
            class="editable-field"
            [class.editing]="editingFields.dataNascita"
          >
            <div class="field-info">
              <div class="field-label">Data di Nascita</div>
              <div class="field-value" *ngIf="!editingFields.dataNascita">
                {{ userProfile.dataNascita ? (userProfile.dataNascita |
                date:'dd/MM/yyyy') : 'Non specificata' }}
                <span *ngIf="userProfile.eta > 0" class="age-display"
                  >({{ userProfile.eta }} anni)</span
                >
              </div>
              <input
                type="date"
                class="field-input"
                [(ngModel)]="userProfile.dataNascita"
                *ngIf="editingFields.dataNascita"
                #dataNascitaInput
              />
            </div>
            <div class="field-actions">
              <button
                class="edit-btn"
                *ngIf="!editingFields.dataNascita"
                (click)="startEdit('dataNascita')"
                [disabled]="saving"
              >
                Modifica <i class="fas fa-edit"></i>
              </button>
              <button
                class="save-btn"
                *ngIf="editingFields.dataNascita"
                (click)="saveField('dataNascita')"
                [disabled]="saving"
              >
                {{ saving ? 'Salvando...' : 'Salva' }}
              </button>
              <button
                class="cancel-btn"
                *ngIf="editingFields.dataNascita"
                (click)="cancelEdit('dataNascita')"
                [disabled]="saving"
              >
                Annulla
              </button>
            </div>
          </div>

          <!-- Password Change -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Password</div>
              <div class="field-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            </div>
            <div class="field-actions">
              <button class="password-btn" (click)="openPasswordModal()">
                <i class="fas fa-key"></i> Cambia Password
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• MATCHING TAB -->
    <div *ngIf="selectedTab === 'matching'" class="ng-div">
      <!-- Preferenze Matching Section -->
      <div class="settings-card mb-4">
        <div class="section-header">
          <h3 class="mb-0">üíï Preferenze di Matching</h3>
        </div>
        <div class="p-4">
          <!-- Genere Preferito -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Genere Preferito</div>
              <div class="field-value">Chi ti interessa incontrare</div>
            </div>
            <div class="field-actions">
              <div class="gender-badges">
                <span
                  class="gender-badge male"
                  [class.selected]="preferences.generePreferito === 'MASCHIO'"
                  (click)="selectGender('MASCHIO')"
                >
                  üë® Uomini
                </span>
                <span
                  class="gender-badge female"
                  [class.selected]="preferences.generePreferito === 'FEMMINA'"
                  (click)="selectGender('FEMMINA')"
                >
                  üë© Donne
                </span>
              </div>
            </div>
          </div>

          <!-- Fascia d'Et√† -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Fascia d'Et√†</div>
              <div class="field-value">Et√† minima e massima dei tuoi match</div>
            </div>
            <div class="field-actions w-100">
              <div class="row g-3 mt-2">
                <div class="col-6">
                  <label class="form-label small">Et√† Minima</label>
                  <div class="range-container">
                    <input
                      type="range"
                      class="range-slider"
                      min="18"
                      max="65"
                      [(ngModel)]="preferences.minEta"
                      (input)="updateAgeRange()"
                    />
                    <span class="range-value">{{ preferences.minEta }}</span>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label small">Et√† Massima</label>
                  <div class="range-container">
                    <input
                      type="range"
                      class="range-slider"
                      min="18"
                      max="65"
                      [(ngModel)]="preferences.maxEta"
                      (input)="updateAgeRange()"
                    />
                    <span class="range-value">{{ preferences.maxEta }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Distanza Massima -->
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Distanza Massima</div>
              <div class="field-value">Raggio di ricerca per i match</div>
            </div>
            <div class="field-actions w-50">
              <div class="range-container mt-2">
                <input
                  type="range"
                  class="range-slider"
                  min="5"
                  max="500"
                  [(ngModel)]="preferences.distanzaMax"
                  (input)="updateDistance()"
                />
                <span class="range-value"
                  >{{ preferences.distanzaMax }} km</span
                >
              </div>
            </div>
          </div>

          <!-- üî• PULSANTE SALVA PREFERENZE -->
          <div class="mt-4">
            <button
              class="btn btn-primary btn-lg w-100"
              (click)="savePreferences()"
              [disabled]="saving"
            >
              <i class="fas fa-save"></i>
              {{ saving ? 'Salvando...' : 'Salva Preferenze' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• THEME TAB -->
    <div *ngIf="selectedTab === 'theme'" class="ng-div">
      <!-- Tema Section -->
      <div class="settings-card mb-4">
        <div class="section-header">
          <h3 class="mb-0">üé® Tema</h3>
        </div>
        <div class="p-4">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="field-label">Tema Scuro</div>
              <div class="field-value">
                Attiva il tema scuro per un'esperienza pi√π rilassante
              </div>
            </div>
            <div
              class="toggle-switch"
              [class.active]="isDarkTheme"
              (click)="toggleTheme()"
            >
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• NOTIFICATIONS TAB -->
    <div *ngIf="selectedTab === 'notifications'" class="ng-div">
      <!-- Notifiche Section -->
      <div class="settings-card mb-4">
        <div class="section-header">
          <h3 class="mb-0">üîî Notifiche</h3>
        </div>
        <div class="p-4">
          <div class="editable-field">
            <div class="field-info">
              <div class="field-label">Notifiche Attive</div>
              <div class="field-value">
                Ricevi notifiche per match e messaggi
              </div>
            </div>
            <div
              class="toggle-switch"
              [class.active]="userProfile.notificheAttive"
              (click)="toggleNotifications()"
            >
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• ACTIONS TAB -->
    <div *ngIf="selectedTab === 'actions'" class="ng-div">
      <!-- Account Actions -->
      <div class="settings-card">
        <div class="section-header">
          <h3 class="mb-0">‚ö†Ô∏è Azioni Account</h3>
        </div>
        <div class="p-4">
          <div class="d-grid gap-3">
            <button
              class="btn btn-outline-danger btn-lg"
              (click)="deactivateAccount()"
            >
              <i class="fas fa-user-slash"></i> Disattiva Account
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üî• INTERESTS MODAL - AGGIORNATO -->
<div class="modal fade" id="interestsModal" tabindex="-1" #interestsModal>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üè∑Ô∏è Seleziona i tuoi Interessi</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body interests-modal-body">
        <input
          type="text"
          class="modal-search"
          placeholder="üîç Cerca un interesse..."
          [(ngModel)]="searchTerm"
          (input)="filterInterests()"
        />

        <div class="selected-count">
          Selezionati: {{ selectedInterests.length }} interessi
        </div>

        <!-- Sport & Fitness -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('sport')"
        >
          <div class="category-title">üèÉ‚Äç‚ôÇÔ∏è Sport & Fitness</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.sport"
              class="interest-tag"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Musica & Arte -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('arte')"
        >
          <div class="category-title">üé® Musica & Arte</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.arte"
              class="interest-tag female-style"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Viaggi & Avventura -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('viaggi')"
        >
          <div class="category-title">‚úàÔ∏è Viaggi & Avventura</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.viaggi"
              class="interest-tag"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Cibo & Bevande -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('cibo')"
        >
          <div class="category-title">üçï Cibo & Bevande</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.cibo"
              class="interest-tag female-style"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Tecnologia & Gaming -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('tech')"
        >
          <div class="category-title">üíª Tecnologia & Gaming</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.tech"
              class="interest-tag"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Libri & Cinema -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('cultura')"
        >
          <div class="category-title">üìö Libri & Cinema</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.cultura"
              class="interest-tag female-style"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Animali & Natura -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('natura')"
        >
          <div class="category-title">üêï Animali & Natura</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.natura"
              class="interest-tag"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Lifestyle -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('lifestyle')"
        >
          <div class="category-title">‚ú® Lifestyle</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.lifestyle"
              class="interest-tag female-style"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>

        <!-- Business & Carriera -->
        <div
          class="interest-category"
          [style.display]="getCategoryDisplay('business')"
        >
          <div class="category-title">üíº Business & Carriera</div>
          <div class="interest-grid">
            <span
              *ngFor="let interest of interestCategories.business"
              class="interest-tag"
              [class.selected]="isInterestSelected(interest.key)"
              [style.display]="getInterestDisplay(interest.label)"
              (click)="toggleInterest(interest.key)"
            >
              {{ interest.label }}
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Annulla
        </button>
        <button
          type="button"
          class="btn interests-save-btn"
          (click)="saveInterests()"
          [disabled]="saving"
        >
          <i class="fas fa-save"></i> {{ saving ? 'Salvando...' : 'Salva
          Interessi' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Password Change Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" #passwordModal>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üîê Cambia Password</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-4">
            <label class="form-label field-label">Password Attuale</label>
            <input
              type="password"
              class="form-control password-input"
              [(ngModel)]="passwordData.currentPassword"
              name="currentPassword"
              placeholder="Inserisci password attuale"
            />
          </div>
          <div class="mb-4">
            <label class="form-label field-label">Nuova Password</label>
            <input
              type="password"
              class="form-control password-input"
              [(ngModel)]="passwordData.newPassword"
              name="newPassword"
              placeholder="Inserisci nuova password"
            />
          </div>
          <div class="mb-4">
            <label class="form-label field-label"
              >Conferma Nuova Password</label
            >
            <input
              type="password"
              class="form-control password-input"
              [(ngModel)]="passwordData.confirmPassword"
              name="confirmPassword"
              placeholder="Ripeti nuova password"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Annulla
        </button>
        <button
          type="button"
          class="btn password-save-btn"
          (click)="changePassword()"
        >
          Cambia Password
        </button>
      </div>
    </div>
  </div>
</div>
